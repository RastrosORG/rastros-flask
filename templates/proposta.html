<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Proposta</title>
    <link rel="icon" href="{{ url_for('static', filename='imagens/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/proposta.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cronometro.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos do painel admin */
        .admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 1px solid #444;
        }
        .btn-admin {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-admin:hover {
            background: #c0392b;
        }
        .update-result {
            margin-top: 10px;
            color: white;
            font-size: 14px;
            max-width: 300px;
        }
        .update-result .success { 
            color: #2ecc71;
        }
        .update-result .error { 
            color: #e74c3c;
        }
        .fa-spin { 
            margin-right: 5px;
        }
        .current-description {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            font-style: italic;
        }
    </style>
</head>
<body>
    
    <!-- Inclui o menu -->
    {% include 'menu.html' %}

    <!-- Adiciona o cronômetro -->
    {% include 'cronometro.html' %}

    <!-- Banner com imagem de fundo -->
    <div class="banner"></div>

    <div class="form-container">
        <h1 class="tracking-in-expand">Criar Proposta</h1>
        <form method="POST" action="/proposta" enctype="multipart/form-data">
            <label for="proposta_nome">Nome da Proposta:</label>
            <input type="text" id="proposta_nome" name="proposta_nome" required>

            <label for="descricao">Descrição:</label>
            <textarea id="descricao" name="descricao" rows="5" required></textarea>

            <div class="anexos-container">
                <label>Anexar Arquivos:</label>
                <div class="anexos-area" id="area-arrastar-soltar">
                    <i class="fas fa-paperclip anexar-icon" onclick="document.getElementById('arquivos').click()"></i>
                    <input type="file" id="arquivos" name="arquivos" multiple style="display: none;" onchange="atualizarListaAnexos(event)">
                    <div id="lista-anexos" class="lista-anexos">
                        Nenhum arquivo enviado
                    </div>
                </div>
            </div>

            <div class="botoes-container">
                <button type="submit">Criar Proposta</button>
                <a href="{{ url_for('tarefas') }}" class="btn gerenciar-btn">Gerenciar Propostas</a>
            </div>
        </form>
    </div>

    <!-- Painel Admin Temporário -->
    {% if session.get('is_evaluator') == 1 %}
    <div class="admin-panel">
        <h3 style="color:white;margin-top:0;margin-bottom:10px;">Ferramenta Temporária</h3>
        <button onclick="updateNewsCategory()" class="btn-admin">
            <i class="fas fa-sync-alt"></i> Atualizar Categoria Notícias
        </button>
        <div id="update-result" class="update-result">
            <div class="current-description">
                <i class="fas fa-spinner fa-spin"></i> Carregando descrição atual...
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Inclui o JavaScript do cronômetro -->
    <script src="{{ url_for('static', filename='js/cronometro.js') }}"></script>

    <script>
        // Lista de arquivos selecionados
        let arquivosSelecionados = [];
    
        // Função para atualizar a lista de anexos
        function atualizarListaAnexos(event) {
            const novosArquivos = Array.from(event.target.files);
    
            // Adiciona apenas os novos arquivos à lista
            novosArquivos.forEach(novoArquivo => {
                const arquivoExistente = arquivosSelecionados.find(arquivo => 
                    arquivo.name === novoArquivo.name && arquivo.size === novoArquivo.size
                );
                if (!arquivoExistente) {
                    arquivosSelecionados.push(novoArquivo);
                }
            });
    
            const listaAnexos = document.getElementById('lista-anexos');
            atualizarExibicaoAnexos(listaAnexos);
    
            // Atualizar o input de arquivos
            const dataTransfer = new DataTransfer();
            arquivosSelecionados.forEach(arquivo => dataTransfer.items.add(arquivo));
            event.target.files = dataTransfer.files;
        }
    
        // Função para remover um anexo da lista
        function removerAnexo(index) {
            arquivosSelecionados.splice(index, 1);
            const inputArquivos = document.getElementById('arquivos');
    
            // Atualizar o input de arquivos
            const dataTransfer = new DataTransfer();
            arquivosSelecionados.forEach(arquivo => dataTransfer.items.add(arquivo));
            inputArquivos.files = dataTransfer.files;
    
            // Atualizar a exibição
            const listaAnexos = document.getElementById('lista-anexos');
            atualizarExibicaoAnexos(listaAnexos);
        }
    
        // Função para atualizar a exibição dos anexos
        function atualizarExibicaoAnexos(elemento) {
            elemento.innerHTML = '';
    
            if (arquivosSelecionados.length > 0) {
                arquivosSelecionados.forEach((arquivo, index) => {
                    const icone = obterIconePorTipo(arquivo.type);
                    const itemAnexo = document.createElement('div');
                    itemAnexo.className = 'item-anexo';
                    itemAnexo.innerHTML = `
                        <span class="arquivo-info">
                            ${icone} ${arquivo.name} (${formatarTamanho(arquivo.size)})
                        </span>
                        <i class="fas fa-times remover-anexo" onclick="removerAnexo(${index})"></i>
                    `;
                    elemento.appendChild(itemAnexo);
                });
            } else {
                elemento.innerHTML = 'Nenhum arquivo enviado';
            }
        }
    
        // Função para obter o ícone correspondente ao tipo de arquivo
        function obterIconePorTipo(tipo) {
            if (tipo.startsWith('image/')) {
                return '<i class="fas fa-file-image"></i>';
            } else if (tipo.startsWith('video/')) {
                return '<i class="fas fa-file-video"></i>';
            } else if (tipo === 'application/pdf') {
                return '<i class="fas fa-file-pdf"></i>';
            } else if (tipo.includes('spreadsheet') || tipo.includes('excel')) {
                return '<i class="fas fa-file-excel"></i>';
            } else if (tipo.includes('word')) {
                return '<i class="fas fa-file-word"></i>';
            } else if (tipo.includes('zip') || tipo.includes('compressed')) {
                return '<i class="fas fa-file-archive"></i>';
            } else {
                return '<i class="fas fa-file"></i>';
            }
        }
    
        // Função para formatar tamanho do arquivo
        function formatarTamanho(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    
        // Função para arrastar e soltar arquivos
        const areaArrastarSoltar = document.getElementById('area-arrastar-soltar');
    
        areaArrastarSoltar.addEventListener('dragover', (e) => {
            e.preventDefault();
            areaArrastarSoltar.classList.add('arrastando');
        });
    
        areaArrastarSoltar.addEventListener('dragleave', () => {
            areaArrastarSoltar.classList.remove('arrastando');
        });
    
        areaArrastarSoltar.addEventListener('drop', (e) => {
            e.preventDefault();
            areaArrastarSoltar.classList.remove('arrastando');
    
            const arquivos = e.dataTransfer.files;
            const inputArquivos = document.getElementById('arquivos');
    
            // Adiciona os arquivos ao input
            const dataTransfer = new DataTransfer();
            Array.from(inputArquivos.files).forEach(arquivo => dataTransfer.items.add(arquivo));
            Array.from(arquivos).forEach(arquivo => dataTransfer.items.add(arquivo));
            inputArquivos.files = dataTransfer.files;
    
            // Atualiza a lista de anexos
            atualizarListaAnexos({ target: inputArquivos });
        });

        // =============================================
        // FUNÇÕES PARA ATUALIZAÇÃO DA CATEGORIA NOTÍCIAS
        // =============================================

        // Verifica o estado atual ao carregar a página
        function loadCurrentDescription() {
            fetch('/admin/update_news_category', {
                method: 'GET',
                headers: {
                    'X-Update-Token': 'R4str0s2024!'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Erro na requisição');
                return response.json();
            })
            .then(data => {
                const resultDiv = document.getElementById('update-result');
                resultDiv.innerHTML = `
                    <div class="current-description">
                        <strong>Descrição atual:</strong><br>
                        "${data.current_description}"
                    </div>
                `;
            })
            .catch(error => {
                const resultDiv = document.getElementById('update-result');
                resultDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> Não foi possível carregar a descrição atual
                    </div>
                `;
                console.error('Erro:', error);
            });
        }

        // Atualiza a categoria
        function updateNewsCategory() {
            const resultDiv = document.getElementById('update-result');
            resultDiv.innerHTML = `
                <div class="current-description">
                    <i class="fas fa-spinner fa-spin"></i> Atualizando...
                </div>
            `;
            
            fetch('/admin/update_news_category', {
                method: 'POST',
                headers: {
                    'X-Update-Token': 'R4str0s2024!',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Erro na requisição');
                return response.json();
            })
            .then(data => {
                if(data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                    `;
                    // Recarrega a descrição atual após 2 segundos
                    setTimeout(loadCurrentDescription, 2000);
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-times-circle"></i> Erro: ${error.message || 'Falha na atualização'}
                    </div>
                `;
                console.error('Erro:', error);
            });
        }

        // Carrega a descrição quando a página é carregada
        if (document.querySelector('.admin-panel')) {
            loadCurrentDescription();
        }
    </script>
</body>
</html>